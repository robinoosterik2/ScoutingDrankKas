FROM node:18 AS base
WORKDIR /app
# Enable pnpm via corepack
RUN corepack enable && corepack prepare pnpm@latest --activate
COPY app/pnpm-lock.yaml app/package.json ./
RUN pnpm install --frozen-lockfile
COPY app .

FROM base AS builder
# Generate Prisma client BEFORE building
RUN pnpm prisma generate
RUN pnpm run build

FROM node:18 AS production
WORKDIR /app
ENV NODE_ENV=production
ENV DATABASE_URL=file:/var/data/prod.db
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy package files
COPY --from=builder /app/pnpm-lock.yaml /app/package.json ./

# Install all dependencies (include dev for Prisma CLI), then prune later
RUN pnpm install --frozen-lockfile

# Copy prisma schema first
COPY --from=builder /app/prisma ./prisma

# Generate Prisma client in production environment
RUN pnpm prisma generate

# Copy the built application (now Prisma client matches)
COPY --from=builder /app/.output ./.output

# Prune dev deps, then clean pnpm store
RUN pnpm prune --prod && pnpm store prune

EXPOSE 3000

# Run migrations against the SQLite file on the mounted disk, then start Nitro
CMD ["sh", "-c", "pnpm exec prisma migrate deploy || pnpm exec prisma db push; node .output/server/index.mjs"]
